# Debugging API Authentication Issues in Laravel Passport

## Potential Issues and Solutions

### 1. Token Expiration
**Issue**: Passport tokens may be expiring between requests, especially if the application is using short-lived tokens without proper refresh token handling.

**Debugging**:
- Check token expiration time in `AuthServiceProvider` (typically in `boot()` method)
- Verify if client is properly handling token refresh

**Solution**:
```php
// In AuthServiceProvider.php
Passport::tokensExpireIn(now()->addDays(15)); // Extend token lifetime if needed
Passport::refreshTokensExpireIn(now()->addDays(30));
```

### 2. Token Storage Issues
**Issue**: The token might not be properly stored or sent with requests intermittently.

**Debugging**:
- Verify headers in failing requests
- Check if token is being properly attached to axios/fetch requests

**Solution**:
Ensure consistent token attachment:
```javascript
// Frontend example (Axios)
axios.interceptors.request.use(config => {
    const token = localStorage.getItem('token');
    if (token) {
        config.headers.Authorization = `Bearer ${token}`;
    }
    return config;
});
```

### 3. Middleware Configuration
**Issue**: The `auth:api` middleware might have unexpected behavior.

**Debugging**:
- Check middleware order in route groups
- Verify if other middleware is interfering

**Solution**:
```php
// In routes/api.php
Route::middleware(['auth:api'])->group(function () {
    Route::get('/user/profile', [UserController::class, 'getProfile']);
});
```

### 4. Clock Skew Between Servers
**Issue**: If using multiple servers, clock differences could cause token validation to fail.

**Debugging**:
- Check server times are synchronized
- Verify JWT timestamp validation

**Solution**:
```php
// In config/auth.php
'api' => [
    'driver' => 'passport',
    'provider' => 'users',
    'leeway' => 60, // Add leeway for clock skew
],
```

### 5. Token Revocation Issues
**Issue**: Tokens might be getting revoked unexpectedly.

**Debugging**:
- Check Passport's token tables in database
- Verify if tokens are being purged prematurely

**Solution**:
```php
// Ensure proper token pruning configuration
// In app/Console/Kernel.php
$schedule->command('passport:purge')->hourly();
```

## Debugging Steps

1. **Log Requests**:
```php
// Add to controller constructor
\Log::info('Auth Request', [
    'headers' => request()->headers->all(),
    'token' => request()->bearerToken()
]);
```

2. **Check Token Validity**:
```php
try {
    $user = auth()->userOrFail();
} catch (\Exception $e) {
    \Log::error('Auth Failed', ['error' => $e->getMessage()]);
}
```

3. **Verify Passport Configuration**:
- Check `config/auth.php` has correct guard/provider setup
- Verify Passport routes are properly registered

4. **Test with Postman**:
- Create a collection with token refresh flow
- Automate testing to reproduce intermittent failures

## Final Recommendations

1. Implement proper token refresh mechanism
2. Add detailed logging for authentication failures
3. Consider using Passport's personal access tokens for debugging
4. Monitor Passport's token tables for anomalies
5. Ensure consistent time synchronization across servers

```php
// Example of enhanced controller with better error handling
public function getProfile(Request $request)
{
    try {
        $user = $request->user();
        
        if (!$user) {
            return response()->json([
                'success' => false,
                'error' => 'User not found'
            ], 404);
        }

        return response()->json([
            'success' => true,
            'data' => $user
        ]);
        
    } catch (\Exception $e) {
        \Log::error('Profile Error', [
            'error' => $e->getMessage(),
            'token' => $request->bearerToken()
        ]);
        
        return response()->json([
            'success' => false,
            'error' => 'Authentication error'
        ], 401);
    }
}
```

