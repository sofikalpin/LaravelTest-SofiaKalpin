# Exercise 3: Dependency Resolution in Laravel Migrations

## Problem

You have two migrations:
- `2023_01_01_000000_create_categories_table.php` - Creates the categories table
- `2023_01_01_000001_create_products_table.php` - Creates the products table with a foreign key to categories

The products migration has already been executed in production, but you discover that the categories migration was accidentally skipped, causing database integrity issues.

## Solution to the Current Problem

### Step 1: Manually create the categories table

First, create a new migration for the missing table:

```bash
php artisan make:migration create_missing_categories_table
```

In the new migration file, replicate the exact schema from the original categories migration:

```php
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

class CreateMissingCategoriesTable extends Migration
{
    public function up()
    {
        Schema::create('categories', function (Blueprint $table) {
            // Replicate the original schema exactly
            $table->id();
            $table->string('name');
            $table->timestamps();
            // Other fields from the original migration
        });
    }

    public function down()
    {
        Schema::dropIfExists('categories');
    }
}
```

### Step 2: Update the migration batch number

Mark the original categories migration as completed in the `migrations` table:

```bash
php artisan tinker
```

```php
DB::table('migrations')->insert([
    'migration' => '2023_01_01_000000_create_categories_table',
    'batch' => 1 // Use the appropriate batch number for your environment
]);
```

### Step 3: Run the new migration

```bash
php artisan migrate
```

## Preventing Similar Issues in the Future

### 1. Use Dependent Table Verification

```php
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

class CreateProductsTableWithVerification extends Migration
{
    public function up()
    {
        Schema::create('products', function (Blueprint $table) {
            $table->id();
            $table->string('name');
            // Other fields
            
            if (Schema::hasTable('categories')) {
                $table->foreignId('category_id')->constrained();
            } else {
                throw new \Exception('The categories table must exist before creating the products table.');
            }
            
            $table->timestamps();
        });
    }

    public function down()
    {
        Schema::dropIfExists('products');
    }
}
```

### 2. Use Detailed Foreign Key Syntax

```php
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

class CreateProductsTableWithDetailedForeignKeys extends Migration
{
    public function up()
    {
        Schema::create('products', function (Blueprint $table) {
            $table->id();
            $table->string('name');
            $table->unsignedBigInteger('category_id');
            $table->timestamps();
            
            $table->foreign('category_id')
                  ->references('id')
                  ->on('categories')
                  ->onDelete('cascade')
                  ->onUpdate('cascade');
        });
    }

    public function down()
    {
        Schema::dropIfExists('products');
    }
}
```

### 3. Specify Explicit Dependencies

```php
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

class CreateProductsTableWithDependencies extends Migration
{
    public $dependencies = [
        '2023_01_01_000000_create_categories_table'
    ];
    
    public function up()
    {
        Schema::create('products', function (Blueprint $table) {
            $table->id();
            $table->string('name');
            $table->foreignId('category_id')->constrained();
            $table->timestamps();
        });
    }

    public function down()
    {
        Schema::dropIfExists('products');
    }
}
```

### 4. Create a Base Migration Class with Dependency Checking

```php
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Support\Facades\DB;

abstract class DependentMigration extends Migration
{
    public $dependencies = [];
    
    public function __construct()
    {
        // Check if dependencies have been run
        $ran = DB::table('migrations')->pluck('migration')->toArray();
        foreach ($this->dependencies as $dependency) {
            if (!in_array($dependency, $ran)) {
                throw new \Exception("Dependency {$dependency} has not been executed.");
            }
        }
    }
}
```

Use it in your migrations:

```php
<?php

use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

class CreateProductsTableExtended extends DependentMigration
{
    public $dependencies = [
        '2023_01_01_000000_create_categories_table'
    ];
    
    public function up()
    {
        Schema::create('products', function (Blueprint $table) {
            $table->id();
            $table->string('name');
            $table->foreignId('category_id')->constrained();
            $table->timestamps();
        });
    }

    public function down()
    {
        Schema::dropIfExists('products');
    }
}
```

### 5. Use Transactions for Atomic Migrations

```php
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;
use Illuminate\Support\Facades\DB;

class CreateProductsTableWithTransaction extends Migration
{
    public function up()
    {
        DB::transaction(function () {
            Schema::create('products', function (Blueprint $table) {
                $table->id();
                $table->string('name');
                $table->foreignId('category_id')->constrained();
                $table->timestamps();
            });
        });
    }

    public function down()
    {
        Schema::dropIfExists('products');
    }
}
```