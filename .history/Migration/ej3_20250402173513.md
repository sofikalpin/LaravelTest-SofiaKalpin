# Ejercicio 3: Resolución de Dependencias en Migraciones Laravel

## Problema

Tienes dos migraciones:
- `2023_01_01_000000_create_categories_table.php` - Crea la tabla de categorías
- `2023_01_01_000001_create_products_table.php` - Crea la tabla de productos con una clave foránea a categorías

La migración de productos ya se ha ejecutado en producción, pero descubres que la migración de categorías se omitió accidentalmente, causando problemas de integridad en la base de datos.

## Solución al Problema Actual

### Paso 1: Crear la tabla de categorías manualmente

Primero, crea una nueva migración para la tabla faltante:

```bash
php artisan make:migration create_missing_categories_table
```

En el nuevo archivo de migración, replica el esquema exacto de la migración original de categorías:

```php
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

class CreateMissingCategoriesTable extends Migration
{
    public function up()
    {
        
        Schema::create('categories', function (Blueprint $table) {
            // Replicar exactamente el esquema original
            $table->id();
            $table->string('name');
            $table->timestamps();
            // Otros campos que estaban en la migración original
        });
    }

    public function down()
    {
        Schema::dropIfExists('categories');
    }
}
```

### Paso 2: Actualizar el número de lote de migración

Marca la migración original de categorías como completada en la tabla `migrations`:

```bash
php artisan tinker
```

```php
DB::table('migrations')->insert([
    'migration' => '2023_01_01_000000_create_categories_table',
    'batch' => 1 // Usar el número de lote apropiado para tu entorno
]);
```

### Paso 3: Ejecutar la nueva migración

```bash
php artisan migrate
```

## Prevención de Problemas Similares en el Futuro

### 1. Usar Verificación de Tablas Dependientes

```php
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

class CreateProductsTableWithVerification extends Migration
{
    public function up()
    {
        Schema::create('products', function (Blueprint $table) {
            $table->id();
            $table->string('name');
            // Otros campos
            
            if (Schema::hasTable('categories')) {
                $table->foreignId('category_id')->constrained();
            } else {
                throw new \Exception('La tabla categories debe existir antes de crear la tabla products.');
            }
            
            $table->timestamps();
        });
    }

    public function down()
    {
        Schema::dropIfExists('products');
    }
}
```

### 2. Usar Sintaxis Detallada para Claves Foráneas

```php
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

class CreateProductsTableWithDetailedForeignKeys extends Migration
{
    public function up()
    {
        Schema::create('products', function (Blueprint $table) {
            $table->id();
            $table->string('name');
            $table->unsignedBigInteger('category_id');
            $table->timestamps();
            
            $table->foreign('category_id')
                  ->references('id')
                  ->on('categories')
                  ->onDelete('cascade')
                  ->onUpdate('cascade');
        });
    }

    public function down()
    {
        Schema::dropIfExists('products');
    }
}
```

### 3. Especificar Dependencias Explícitamente

```php
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

class CreateProductsTableWithDependencies extends Migration
{
    
    public $dependencies = [
        '2023_01_01_000000_create_categories_table'
    ];
    
    public function up()
    {
        Schema::create('products', function (Blueprint $table) {
            $table->id();
            $table->string('name');
            $table->foreignId('category_id')->constrained();
            $table->timestamps();
        });
    }

    public function down()
    {
        Schema::dropIfExists('products');
    }
}
```

### 4. Crear una Clase Base de Migración con Comprobación de Dependencias

```php
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Support\Facades\DB;

abstract class DependentMigration extends Migration
{
    public $dependencies = [];
    
    public function __construct()
    {
        // Verificar si las dependencias se han ejecutado
        $ran = DB::table('migrations')->pluck('migration')->toArray();
        foreach ($this->dependencies as $dependency) {
            if (!in_array($dependency, $ran)) {
                throw new \Exception("La dependencia {$dependency} no ha sido ejecutada.");
            }
        }
    }
}
```

Usarlo en mis migraciones

```php
<?php

use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

class CreateProductsTableExtended extends DependentMigration
{
    public $dependencies = [
        '2023_01_01_000000_create_categories_table'
    ];
    
    public function up()
    {
        Schema::create('products', function (Blueprint $table) {
            $table->id();
            $table->string('name');
            $table->foreignId('category_id')->constrained();
            $table->timestamps();
        });
    }

    public function down()
    {
        Schema::dropIfExists('products');
    }
}
```

### 5. Usar Transacciones para Migraciones Atómicas

```php
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;
use Illuminate\Support\Facades\DB;

class CreateProductsTableWithTransaction extends Migration
{
    public function up()
    {
        DB::transaction(function () {
            Schema::create('products', function (Blueprint $table) {
                $table->id();
                $table->string('name');
                $table->foreignId('category_id')->constrained();
                $table->timestamps();
            });
        });
    }

    public function down()
    {
        Schema::dropIfExists('products');
    }
}
```